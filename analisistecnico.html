<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Análisis Técnico EUR/USD - Real Time</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #fff;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5rem;
            color: #00d4ff;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 25px;
            margin-bottom: 30px;
        }

        .chart-section {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 20px;
        }

        .sidebar {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 20px;
        }

        .api-config {
            background: rgba(255, 215, 0, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 215, 0, 0.3);
        }

        .api-input {
            width: 100%;
            padding: 10px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            margin-bottom: 10px;
        }

        .api-button {
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            color: #000;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            width: 100%;
        }

        .timeframe-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tf-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 8px 15px;
            border-radius: 8px;
            color: #fff;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .tf-btn:hover, .tf-btn.active {
            background: linear-gradient(45deg, #00d4ff, #00ff88);
            color: #000;
        }

        .price-display {
            background: rgba(0, 212, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
        }

        .current-price {
            font-size: 2rem;
            font-weight: bold;
            color: #00d4ff;
        }

        .price-change {
            font-size: 1.2rem;
            margin-top: 5px;
        }

        .positive { color: #00ff88; }
        .negative { color: #ff6b6b; }

        .loading {
            text-align: center;
            padding: 20px;
            color: #00d4ff;
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            border-top: 4px solid #00d4ff;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .setup-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid;
        }

        .setup-bullish { border-left-color: #00ff88; }
        .setup-bearish { border-left-color: #ff6b6b; }
        .setup-neutral { border-left-color: #ffd700; }

        .setup-title {
            font-weight: bold;
            margin-bottom: 8px;
            color: #ffd700;
        }

        .setup-details {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .levels-section {
            margin-bottom: 25px;
        }

        .level-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .support { border-left: 3px solid #00ff88; }
        .resistance { border-left: 3px solid #ff6b6b; }

        .tradingview-widget {
            width: 100%;
            height: 500px;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .analysis-section {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 20px;
        }

        .indicator-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .indicator-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .indicator-value {
            font-size: 1.5rem;
            font-weight: bold;
            margin: 10px 0;
        }

        .bullish-indicator { color: #00ff88; }
        .bearish-indicator { color: #ff6b6b; }
        .neutral-indicator { color: #ffd700; }

        .error-message {
            background: rgba(255, 107, 107, 0.1);
            border: 1px solid rgba(255, 107, 107, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            color: #ff6b6b;
            text-align: center;
        }

        .success-message {
            background: rgba(0, 255, 136, 0.1);
            border: 1px solid rgba(0, 255, 136, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            color: #00ff88;
            text-align: center;
        }

        @media (max-width: 768px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Análisis Técnico EUR/USD - Datos Reales</h1>
        
        <div class="api-config">
            <h4 style="margin-bottom: 10px; color: #ffd700;">Configuración API</h4>
            <p style="font-size: 0.9rem; margin-bottom: 15px; opacity: 0.8;">
                Necesitas una API key gratuita de Alpha Vantage o usar Finnhub
            </p>
            <select id="apiProvider" class="api-input">
                <option value="alphavantage">Alpha Vantage (Recomendado)</option>
                <option value="finnhub">Finnhub</option>
                <option value="fxapi">Fixer.io</option>
            </select>
            <input type="password" id="apiKey" class="api-input" placeholder="Q2586VZ0NLVEC0RA">
            <button class="api-button" onclick="initializeAPI()">Conectar API</button>
            <div style="margin-top: 10px;">
                <small style="opacity: 0.7;">
                    <a href="https://www.alphavantage.co/support/#api-key" target="_blank" style="color: #00d4ff;">
                        Obtener API Key gratuita
                    </a>
                </small>
            </div>
        </div>
        
        <div class="main-grid">
            <div class="chart-section">
                <div class="timeframe-selector">
                    <button class="tf-btn" onclick="selectTimeframe('1min')" id="tf-1min">1M</button>
                    <button class="tf-btn" onclick="selectTimeframe('5min')" id="tf-5min">5M</button>
                    <button class="tf-btn" onclick="selectTimeframe('15min')" id="tf-15min">15M</button>
                    <button class="tf-btn active" onclick="selectTimeframe('60min')" id="tf-60min">1H</button>
                    <button class="tf-btn" onclick="selectTimeframe('daily')" id="tf-daily">1D</button>
                </div>

                <!-- TradingView Widget -->
                <div class="tradingview-widget" id="tradingview-widget">
                    <div style="height: 100%; width: 100%; background: rgba(255,255,255,0.05); display: flex; align-items: center; justify-content: center; border-radius: 10px;">
                        <div style="text-align: center;">
                            <div class="spinner"></div>
                            <p>Cargando gráfico TradingView...</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="sidebar">
                <div class="price-display">
                    <div class="current-price" id="currentPrice">--</div>
                    <div class="price-change" id="priceChange">Esperando datos...</div>
                    <div style="margin-top: 10px; font-size: 0.9rem;" id="lastUpdate">--</div>
                </div>

                <div class="levels-section">
                    <h4 style="margin-bottom: 15px; color: #00d4ff;">Niveles Técnicos</h4>
                    <div id="technicalLevels">
                        <div class="loading">
                            <div class="spinner"></div>
                            <p>Calculando niveles...</p>
                        </div>
                    </div>
                </div>

                <div id="setupsContainer">
                    <h4 style="margin-bottom: 15px; color: #ffd700;">Análisis Actual</h4>
                    <div class="setup-card setup-neutral">
                        <div class="setup-title">Sin datos</div>
                        <div class="setup-details">Conecta una API para comenzar</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="analysis-section">
            <h3 style="margin-bottom: 20px; color: #00ff88;">Indicadores Técnicos</h3>
            <div class="indicator-grid" id="indicatorGrid">
                <div class="indicator-card">
                    <div>RSI (14)</div>
                    <div class="indicator-value neutral-indicator" id="rsiValue">--</div>
                </div>
                <div class="indicator-card">
                    <div>MACD</div>
                    <div class="indicator-value neutral-indicator" id="macdValue">--</div>
                </div>
                <div class="indicator-card">
                    <div>Moving Average</div>
                    <div class="indicator-value neutral-indicator" id="maValue">--</div>
                </div>
                <div class="indicator-card">
                    <div>Volumen</div>
                    <div class="indicator-value neutral-indicator" id="volumeValue">--</div>
                </div>
            </div>
        </div>
    </div>

    <!-- TradingView Script -->
    <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-advanced-chart.js" async>
    {
        "width": "100%",
        "height": "500",
        "symbol": "FX:EURUSD",
        "interval": "60",
        "timezone": "Etc/UTC",
        "theme": "dark",
        "style": "1",
        "locale": "es",
        "toolbar_bg": "#f1f3f6",
        "enable_publishing": false,
        "hide_top_toolbar": false,
        "hide_legend": false,
        "save_image": false,
        "container_id": "tradingview-widget"
    }
    </script>

    <script>
        let apiProvider = 'alphavantage';
        let apiKey = '';
        let currentTimeframe = '60min';
        let priceData = {};
        let isConnected = false;
        let updateInterval;

        function initializeAPI() {
            apiProvider = document.getElementById('apiProvider').value;
            apiKey = document.getElementById('apiKey').value.trim();
            
            if (!apiKey) {
                showError('Por favor ingresa tu API Key');
                return;
            }
            
            connectAPI();
        }

        async function connectAPI() {
            try {
                showLoading('Conectando a la API...');
                
                // Test connection
                const testData = await fetchPriceData();
                
                if (testData) {
                    isConnected = true;
                    showSuccess('API conectada exitosamente');
                    startRealTimeUpdates();
                    updateDisplay(testData);
                } else {
                    throw new Error('No se pudieron obtener datos');
                }
                
            } catch (error) {
                showError(`Error de conexión: ${error.message}`);
                console.error('API Error:', error);
            }
        }

        async function fetchPriceData() {
            switch(apiProvider) {
                case 'alphavantage':
                    return await fetchAlphaVantageData();
                case 'finnhub':
                    return await fetchFinnhubData();
                case 'fxapi':
                    return await fetchFxApiData();
                default:
                    throw new Error('Proveedor no soportado');
            }
        }

        async function fetchAlphaVantageData() {
            const interval = currentTimeframe;
            const url = `https://www.alphavantage.co/query?function=FX_INTRADAY&from_symbol=EUR&to_symbol=USD&interval=${interval}&apikey=${apiKey}`;
            
            const response = await fetch(url);
            const data = await response.json();
            
            if (data['Error Message']) {
                throw new Error('API Key inválida o límite excedido');
            }
            
            if (data['Note']) {
                throw new Error('Límite de llamadas excedido. Espera 1 minuto.');
            }
            
            const timeSeries = data[`Time Series FX (${interval})`];
            if (!timeSeries) {
                throw new Error('No se encontraron datos para el par EUR/USD');
            }
            
            return processTimeSeriesData(timeSeries);
        }

        async function fetchFinnhubData() {
            const url = `https://finnhub.io/api/v1/forex/rates?base=EUR&token=${apiKey}`;
            
            const response = await fetch(url);
            const data = await response.json();
            
            if (!data.quote || !data.quote.USD) {
                throw new Error('No se pudo obtener la cotización EUR/USD');
            }
            
            return {
                current: data.quote.USD,
                change: 0,
                changePercent: 0,
                timestamp: new Date().toISOString(),
                prices: [data.quote.USD]
            };
        }

        async function fetchFxApiData() {
            const url = `http://data.fixer.io/api/latest?access_key=${apiKey}&base=EUR&symbols=USD`;
            
            const response = await fetch(url);
            const data = await response.json();
            
            if (!data.success) {
                throw new Error(data.error?.info || 'Error en la API');
            }
            
            return {
                current: data.rates.USD,
                change: 0,
                changePercent: 0,
                timestamp: data.date,
                prices: [data.rates.USD]
            };
        }

        function processTimeSeriesData(timeSeries) {
            const entries = Object.entries(timeSeries);
            const latest = entries[0];
            const previous = entries[1];
            
            const currentPrice = parseFloat(latest[1]['4. close']);
            const previousPrice = previous ? parseFloat(previous[1]['4. close']) : currentPrice;
            
            const change = currentPrice - previousPrice;
            const changePercent = (change / previousPrice) * 100;
            
            const prices = entries.slice(0, 50).map(entry => 
                parseFloat(entry[1]['4. close'])
            ).reverse();
            
            return {
                current: currentPrice,
                change: change,
                changePercent: changePercent,
                timestamp: latest[0],
                prices: prices,
                volume: parseFloat(latest[1]['5. volume']) || 0,
                high: parseFloat(latest[1]['2. high']),
                low: parseFloat(latest[1]['3. low']),
                open: parseFloat(latest[1]['1. open'])
            };
        }

        function updateDisplay(data) {
            // Update price display
            document.getElementById('currentPrice').textContent = data.current.toFixed(4);
            
            const changeElement = document.getElementById('priceChange');
            const sign = data.change >= 0 ? '+' : '';
            changeElement.textContent = `${sign}${data.change.toFixed(4)} (${sign}${data.changePercent.toFixed(2)}%)`;
            changeElement.className = `price-change ${data.change >= 0 ? 'positive' : 'negative'}`;
            
            document.getElementById('lastUpdate').textContent = `Actualizado: ${new Date().toLocaleTimeString()}`;
            
            // Calculate technical indicators
            updateTechnicalIndicators(data);
            
            // Update levels
            updateTechnicalLevels(data);
            
            // Update setups
            updateTradingSetups(data);
        }

        function updateTechnicalIndicators(data) {
            if (!data.prices || data.prices.length < 14) return;
            
            // Calculate RSI
            const rsi = calculateRSI(data.prices, 14);
            const rsiElement = document.getElementById('rsiValue');
            rsiElement.textContent = rsi.toFixed(2);
            
            if (rsi > 70) {
                rsiElement.className = 'indicator-value bearish-indicator';
            } else if (rsi < 30) {
                rsiElement.className = 'indicator-value bullish-indicator';
            } else {
                rsiElement.className = 'indicator-value neutral-indicator';
            }
            
            // Simple Moving Average
            const ma = calculateMA(data.prices, 20);
            const maElement = document.getElementById('maValue');
            maElement.textContent = ma.toFixed(4);
            
            if (data.current > ma) {
                maElement.className = 'indicator-value bullish-indicator';
            } else {
                maElement.className = 'indicator-value bearish-indicator';
            }
            
            // Volume (if available)
            if (data.volume) {
                document.getElementById('volumeValue').textContent = formatVolume(data.volume);
            }
            
            // MACD (simplified)
            const macd = calculateSimpleMACD(data.prices);
            document.getElementById('macdValue').textContent = macd.toFixed(6);
        }

        function calculateRSI(prices, period) {
            let gains = 0;
            let losses = 0;
            
            for (let i = 1; i < period + 1; i++) {
                const change = prices[i] - prices[i - 1];
                if (change > 0) {
                    gains += change;
                } else {
                    losses += Math.abs(change);
                }
            }
            
            const avgGain = gains / period;
            const avgLoss = losses / period;
            
            const rs = avgGain / avgLoss;
            return 100 - (100 / (1 + rs));
        }

        function calculateMA(prices, period) {
            const sum = prices.slice(-period).reduce((a, b) => a + b, 0);
            return sum / period;
        }

        function calculateSimpleMACD(prices) {
            if (prices.length < 26) return 0;
            
            const ema12 = calculateEMA(prices, 12);
            const ema26 = calculateEMA(prices, 26);
            
            return ema12 - ema26;
        }

        function calculateEMA(prices, period) {
            const k = 2 / (period + 1);
            let ema = prices[0];
            
            for (let i = 1; i < prices.length; i++) {
                ema = (prices[i] * k) + (ema * (1 - k));
            }
            
            return ema;
        }

        function updateTechnicalLevels(data) {
            const prices = data.prices || [];
            if (prices.length < 10) return;
            
            // Calculate support and resistance levels
            const highs = [];
            const lows = [];
            
            for (let i = 2; i < prices.length - 2; i++) {
                if (prices[i] > prices[i-1] && prices[i] > prices[i+1] && 
                    prices[i] > prices[i-2] && prices[i] > prices[i+2]) {
                    highs.push(prices[i]);
                }
                if (prices[i] < prices[i-1] && prices[i] < prices[i+1] && 
                    prices[i] < prices[i-2] && prices[i] < prices[i+2]) {
                    lows.push(prices[i]);
                }
            }
            
            const resistance = highs.length > 0 ? Math.max(...highs) : data.high || data.current * 1.01;
            const support = lows.length > 0 ? Math.min(...lows) : data.low || data.current * 0.99;
            
            document.getElementById('technicalLevels').innerHTML = `
                <div class="level-item resistance">
                    <span>Resistencia</span>
                    <span>${resistance.toFixed(4)}</span>
                </div>
                <div class="level-item support">
                    <span>Soporte</span>
                    <span>${support.toFixed(4)}</span>
                </div>
            `;
        }

        function updateTradingSetups(data) {
            const rsi = data.prices ? calculateRSI(data.prices, 14) : 50;
            const ma = data.prices ? calculateMA(data.prices, 20) : data.current;
            
            let setupType = 'neutral';
            let setupTitle = 'Sin señal clara';
            let setupDetails = 'Esperando confirmación del mercado';
            
            // Generate trading signals based on indicators
            if (rsi > 70 && data.current < ma) {
                setupType = 'bearish';
                setupTitle = 'Señal Bajista';
                setupDetails = `RSI sobrecomprado (${rsi.toFixed(2)}) y precio bajo MA`;
            } else if (rsi < 30 && data.current > ma) {
                setupType = 'bullish';
                setupTitle = 'Señal Alcista';
                setupDetails = `RSI sobrevendido (${rsi.toFixed(2)}) y precio sobre MA`;
            } else if (data.current > ma) {
                setupType = 'bullish';
                setupTitle = 'Tendencia Alcista';
                setupDetails = `Precio sobre media móvil (${ma.toFixed(4)})`;
            } else if (data.current < ma) {
                setupType = 'bearish';
                setupTitle = 'Tendencia Bajista';
                setupDetails = `Precio bajo media móvil (${ma.toFixed(4)})`;
            }
            
            document.getElementById('setupsContainer').innerHTML = `
                <h4 style="margin-bottom: 15px; color: #ffd700;">Análisis Actual</h4>
                <div class="setup-card setup-${setupType}">
                    <div class="setup-title">${setupTitle}</div>
                    <div class="setup-details">${setupDetails}</div>
                </div>
            `;
        }

        function formatVolume(volume) {
            if (volume > 1000000) {
                return (volume / 1000000).toFixed(1) + 'M';
            } else if (volume > 1000) {
                return (volume / 1000).toFixed(1) + 'K';
            }
            return volume.toString();
        }

        function selectTimeframe(tf) {
            currentTimeframe = tf;
            document.querySelectorAll('.tf-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`tf-${tf}`).classList.add('active');
            
            if (isConnected) {
                fetchPriceData().then(data => {
                    if (data) updateDisplay(data);
                }).catch(console.error);
            }
        }

        function startRealTimeUpdates() {
            // Clear existing interval
            if (updateInterval) {
                clearInterval(updateInterval);
            }
            
            // Update every 30 seconds
            updateInterval = setInterval(async () => {
                if (isConnected) {
                    try {
                        const data = await fetchPriceData();
                        if (data) updateDisplay(data);
                    } catch (error) {
                        console.error('Update error:', error);
                    }
                }
            }, 30000);
        }

        function showError(message) {
            const existingError = document.querySelector('.error-message');
            if (existingError) existingError.remove();
            
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = message;
            document.querySelector('.api-config').appendChild(errorDiv);
            
            setTimeout(() => errorDiv.remove(), 5000);
        }

        function showSuccess(message) {
            const existingSuccess = document.querySelector('.success-message');
            if (existingSuccess) existingSuccess.remove();
            
            const successDiv = document.createElement('div');
            successDiv.className = 'success-message';
            successDiv.textContent = message;
            document.querySelector('.api-config').appendChild(successDiv);
            
            setTimeout(() => successDiv.remove(), 3000);
        }

        function showLoading(message) {
            const apiConfig = document.querySelector('.api-config');
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'loading';
            loadingDiv.innerHTML = `
                <div class="spinner"></div>
                <p>${message}</p>
            `;
            apiConfig.appendChild(loadingDiv);
            
            setTimeout(() => loadingDiv.remove(), 10000);
        }

        // Initialize TradingView widget when page loads
        window.onload = function() {
            // TradingView widget will load automatically via script tag
        };
    </script>
</body>
</html>
